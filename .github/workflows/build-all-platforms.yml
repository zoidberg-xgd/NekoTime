name: Build All Platforms

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: write
  packages: write

env:
  APP_NAME: NekoTime
  APP_VERSION: 2.2.3

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
          cache: true
      
      - name: Enable macOS desktop and force project recognition
        run: |
          # Enable desktop support
          flutter config --enable-macos-desktop --no-analytics
          # Clear Flutter cache
          flutter precache --macos --force
          # Regenerate project files to ensure recognition
          flutter create --platforms=macos --org=com.nekotime --project-name=neko_time .
      
      - name: Verify project structure
        run: |
          echo "Checking macOS project files..."
          ls -la macos/
          echo "Checking .metadata..."
          cat .metadata
          echo "Running flutter devices..."
          flutter devices
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Run tests
        run: flutter test
          
      - name: Verify macOS project before build
        run: |
          echo "Checking for required macOS files..."
          test -f macos/Runner.xcodeproj/project.pbxproj || (echo "ERROR: project.pbxproj not found" && exit 1)
          test -f macos/Podfile || (echo "ERROR: Podfile not found" && exit 1)
          echo "Installing CocoaPods dependencies..."
          cd macos && pod install && cd ..
          
      - name: Build macOS app
        run: |
          echo "Attempting to build macOS app..."
          flutter build macos --release -v
      
      - name: Create DMG
        run: |
          brew install create-dmg
          mkdir -p dist
          
          create-dmg \
            --volname "${{ env.APP_NAME }}" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "${{ env.APP_NAME }}.app" 175 190 \
            --hide-extension "${{ env.APP_NAME }}.app" \
            --app-drop-link 425 190 \
            --no-internet-enable \
            "dist/${{ env.APP_NAME }}-macOS-v${{ env.APP_VERSION }}.dmg" \
            "build/macos/Build/Products/Release/${{ env.APP_NAME }}.app" || true
      
      - name: Create ZIP (fallback)
        if: always()
        run: |
          mkdir -p dist
          cd build/macos/Build/Products/Release
          zip -r -q "../../../../../dist/${{ env.APP_NAME }}-macOS-v${{ env.APP_VERSION }}.zip" ${{ env.APP_NAME }}.app
      
      - name: Calculate checksums
        run: |
          cd dist
          shasum -a 256 *.dmg *.zip > SHA256SUMS-macOS.txt || true
      
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            dist/*.dmg
            dist/*.zip
            dist/SHA256SUMS-macOS.txt
          retention-days: 30

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
          cache: true
      
      - name: Enable Windows desktop and force project recognition
        run: |
          flutter config --enable-windows-desktop --no-analytics
          flutter precache --windows --force
          flutter create --platforms=windows --org=com.nekotime --project-name=neko_time .
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Run tests
        run: flutter test
      
      - name: Build Windows app
        run: flutter build windows --release
      
      - name: Create portable package
        shell: powershell
        run: |
          $VERSION = "${{ env.APP_VERSION }}"
          $APP_NAME = "${{ env.APP_NAME }}"
          $BUILD_DIR = "build\windows\x64\runner\Release"
          $DIST_DIR = "dist"
          
          # Create dist directory
          New-Item -ItemType Directory -Force -Path $DIST_DIR
          
          # Create package directory
          $PKG_DIR = "$APP_NAME-Windows-v$VERSION"
          New-Item -ItemType Directory -Force -Path "$DIST_DIR\$PKG_DIR"
          
          # Copy files
          Copy-Item -Path "$BUILD_DIR\*" -Destination "$DIST_DIR\$PKG_DIR" -Recurse
          
          # Create README
          @"
          $APP_NAME - çŒ«é“ƒæ—¶é’Ÿ v$VERSION
          ==============================
          
          Windows ä¾¿æºç‰ˆ
          
          è¿è¡Œæ–¹å¼:
          1. åŒå‡» $APP_NAME.exe è¿è¡Œ
          2. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å®‰è£… Visual C++ è¿è¡Œåº“
          
          ç³»ç»Ÿè¦æ±‚:
          - Windows 10 1903 æˆ–æ›´é«˜ç‰ˆæœ¬
          - æŽ¨è Windows 11 ä»¥èŽ·å¾—æœ€ä½³ä½“éªŒ
          
          ä¸»é¢˜ç›®å½•:
          %APPDATA%\$APP_NAME\themes\
          
          æ—¥å¿—ç›®å½•:
          %APPDATA%\$APP_NAME\logs\
          
          å¿«æ·æ“ä½œ:
          - æ‹–åŠ¨çª—å£: æŒ‰ä½å¹¶æ‹–åŠ¨
          - éšè—çª—å£: åŒå‡»æ—¶é’Ÿçª—å£
          - æ˜¾ç¤ºçª—å£: ç‚¹å‡»ç³»ç»Ÿæ‰˜ç›˜å›¾æ ‡
          - æ‰“å¼€è®¾ç½®: æ‰˜ç›˜èœå• â†’ Settings
          
          é—®é¢˜åé¦ˆ:
          https://github.com/zoidberg-xgd/NekoTime/issues
          
          è®¸å¯è¯: MIT License
          "@ | Out-File -FilePath "$DIST_DIR\$PKG_DIR\README.txt" -Encoding UTF8
          
          # Create ZIP
          Compress-Archive -Path "$DIST_DIR\$PKG_DIR" -DestinationPath "$DIST_DIR\$APP_NAME-Windows-v$VERSION.zip" -Force
          
          # Calculate SHA256
          $hash = Get-FileHash "$DIST_DIR\$APP_NAME-Windows-v$VERSION.zip" -Algorithm SHA256
          "$($hash.Hash)  $APP_NAME-Windows-v$VERSION.zip" | Out-File -FilePath "$DIST_DIR\SHA256SUMS-Windows.txt" -Encoding ASCII
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            dist/*.zip
            dist/SHA256SUMS-Windows.txt
          retention-days: 30

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev \
            libayatana-appindicator3-dev
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
          cache: true
      
      - name: Enable Linux desktop and force project recognition
        run: |
          flutter config --enable-linux-desktop --no-analytics
          flutter precache --linux --force
          flutter create --platforms=linux --org=com.nekotime --project-name=neko_time .
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Run tests
        run: flutter test
      
      - name: Build Linux app
        run: flutter build linux --release
      
      - name: Create portable package
        run: |
          VERSION="${{ env.APP_VERSION }}"
          APP_NAME="${{ env.APP_NAME }}"
          BUILD_DIR="build/linux/x64/release/bundle"
          DIST_DIR="dist"
          
          # Create dist directory
          mkdir -p "$DIST_DIR"
          
          # Create package directory
          PKG_DIR="$APP_NAME-Linux-x64-v$VERSION"
          mkdir -p "$DIST_DIR/$PKG_DIR"
          
          # Copy application files
          cp -r "$BUILD_DIR"/* "$DIST_DIR/$PKG_DIR/"
          
          # Copy helper scripts
          mkdir -p "$DIST_DIR/$PKG_DIR/scripts"
          cp scripts/install_linux_deps.sh "$DIST_DIR/$PKG_DIR/scripts/"
          cp scripts/run_linux.sh "$DIST_DIR/$PKG_DIR/"
          chmod +x "$DIST_DIR/$PKG_DIR/neko_time"
          chmod +x "$DIST_DIR/$PKG_DIR/run_linux.sh"
          chmod +x "$DIST_DIR/$PKG_DIR/scripts/install_linux_deps.sh"
          
          # Create README
          cat > "$DIST_DIR/$PKG_DIR/README.txt" << EOF
          $APP_NAME - çŒ«é“ƒæ—¶é’Ÿ v$VERSION
          ==============================
          
          Linux ä¾¿æºç‰ˆ
          
          å¿«é€Ÿå¼€å§‹:
          1. å®‰è£…ä¾èµ–ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰: sudo ./scripts/install_linux_deps.sh
          2. å¯åŠ¨åº”ç”¨: ./run_linux.sh
          æˆ–ç›´æŽ¥è¿è¡Œ: ./neko_time
          
          âš ï¸  é¦–æ¬¡è¿è¡Œå¿…è¯»:
          å¦‚æžœé‡åˆ°é»‘å±æˆ– "No rendering surface available" é”™è¯¯ï¼Œ
          è¯·å…ˆè¿è¡Œä¾èµ–å®‰è£…è„šæœ¬ï¼
          
          ç³»ç»Ÿè¦æ±‚:
          - Linux å‘è¡Œç‰ˆï¼ˆUbuntu 20.04+, Fedora 35+, Arch Linux ç­‰ï¼‰
          - GTK 3.0+
          - çª—å£åˆæˆå™¨ï¼ˆç”¨äºŽé€æ˜Žæ•ˆæžœï¼‰
          
          æŽ¨èæ¡Œé¢çŽ¯å¢ƒ:
          - GNOME 40+
          - KDE Plasma 5.20+
          - Cinnamon 5.0+
          
          ä¸»é¢˜ç›®å½•:
          ~/.local/share/$APP_NAME/themes/
          
          æ—¥å¿—ç›®å½•:
          ~/.local/share/$APP_NAME/logs/
          
          å¿«æ·æ“ä½œ:
          - æ‹–åŠ¨çª—å£: æŒ‰ä½å¹¶æ‹–åŠ¨
          - éšè—çª—å£: åŒå‡»æ—¶é’Ÿçª—å£
          - æ˜¾ç¤ºçª—å£: ç‚¹å‡»ç³»ç»Ÿæ‰˜ç›˜å›¾æ ‡
          - æ‰“å¼€è®¾ç½®: æ‰˜ç›˜èœå• â†’ Settings
          
          å¸¸è§é—®é¢˜:
          1. é€æ˜Žæ•ˆæžœä¸å·¥ä½œ
             - ç¡®ä¿æ¡Œé¢çŽ¯å¢ƒå¯ç”¨äº†åˆæˆå™¨
             - GNOME Wayland: éœ€è¦ AppIndicator æ‰©å±•
          
          2. æ‰˜ç›˜å›¾æ ‡ä¸æ˜¾ç¤º
             - å®‰è£… libayatana-appindicator3
             - GNOME: å®‰è£… appindicator æ‰©å±•
          
          é—®é¢˜åé¦ˆ:
          https://github.com/zoidberg-xgd/NekoTime/issues
          
          è®¸å¯è¯: MIT License
          EOF
          
          # Create tarball
          cd "$DIST_DIR"
          tar -czf "$APP_NAME-Linux-x64-v$VERSION.tar.gz" "$PKG_DIR"
          
          # Calculate SHA256
          sha256sum "$APP_NAME-Linux-x64-v$VERSION.tar.gz" > SHA256SUMS-Linux.txt
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            dist/*.tar.gz
            dist/SHA256SUMS-Linux.txt
          retention-days: 30

  create-release:
    name: Create Release
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # Copy all build artifacts
          find artifacts -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.tar.gz" \) -exec cp {} release-assets/ \;
          
          # Merge SHA256 files
          cat artifacts/*/SHA256SUMS*.txt > release-assets/SHA256SUMS.txt || true
          
          # List files
          ls -lh release-assets/
      
      - name: Create release notes
        run: |
          cat > release-assets/RELEASE_NOTES.md << 'EOF'
          # NekoTime v${{ env.APP_VERSION }} å‘å¸ƒè¯´æ˜Ž
          
          ## ðŸ“¦ ä¸‹è½½
          
          ### macOS
          - **DMG å®‰è£…åŒ…** (æŽ¨è): `NekoTime-macOS-v${{ env.APP_VERSION }}.dmg`
          - **ZIP ä¾¿æºç‰ˆ**: `NekoTime-macOS-v${{ env.APP_VERSION }}.zip`
          - ç³»ç»Ÿè¦æ±‚: macOS 10.14+
          
          ### Windows
          - **ZIP ä¾¿æºç‰ˆ**: `NekoTime-Windows-v${{ env.APP_VERSION }}.zip`
          - ç³»ç»Ÿè¦æ±‚: Windows 10 1903+
          
          ### Linux
          - **TAR.GZ åŽ‹ç¼©åŒ…**: `NekoTime-Linux-x64-v${{ env.APP_VERSION }}.tar.gz`
          - ç³»ç»Ÿè¦æ±‚: Ubuntu 20.04+, Fedora 35+, Arch Linux
          
          ## âœ¨ ä¸»è¦ç‰¹æ€§
          
          - ðŸŽ¨ é€æ˜Žæ¯›çŽ»ç’ƒæ•ˆæžœ
          - ðŸ–±ï¸ è‡ªç”±æ‹–åŠ¨å’Œå¤šå±‚çº§æ˜¾ç¤º
          - ðŸŽ­ å¯è‡ªå®šä¹‰ GIF ä¸»é¢˜ç³»ç»Ÿ
          - ðŸ“Š ç³»ç»Ÿæ‰˜ç›˜é›†æˆ
          - ðŸŒ å¤šè¯­è¨€æ”¯æŒ (ä¸­æ–‡/English)
          - âš¡ ä½Žèµ„æºå ç”¨ï¼Œé«˜æ€§èƒ½
          
          ## ðŸ” å®‰å…¨éªŒè¯
          
          ä¸‹è½½åŽè¯·éªŒè¯ SHA256 æ ¡éªŒå’Œ:
          ```bash
          sha256sum -c SHA256SUMS.txt
          ```
          
          ## ðŸ“š æ–‡æ¡£
          
          - [å®‰è£…æŒ‡å—](https://github.com/zoidberg-xgd/NekoTime#-quick-start)
          - [ä¸»é¢˜å¼€å‘](https://github.com/zoidberg-xgd/NekoTime/blob/main/themes/THEME_GUIDE.md)
          - [æž„å»ºæŒ‡å—](https://github.com/zoidberg-xgd/NekoTime/blob/main/BUILD_GUIDE.md)
          
          ## ðŸ› é—®é¢˜åé¦ˆ
          
          https://github.com/zoidberg-xgd/NekoTime/issues
          
          ---
          
          **å®Œæ•´æ›´æ–°æ—¥å¿—**: [CHANGELOG.md](https://github.com/zoidberg-xgd/NekoTime/blob/main/CHANGELOG.md)
          EOF
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/*
          body_path: release-assets/RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload release info
        uses: actions/upload-artifact@v4
        with:
          name: release-info
          path: release-assets/RELEASE_NOTES.md
          retention-days: 90
